# SQLcl Connection Alias Generators

## Purpose
Generate BASH or ZSH shell aliases for connecting via [SQLcl](https://www.oracle.com/database/sqldeveloper/technologies/sqlcl/) to Oracle databases defined in TNS files or OID LDAP servers.

By default, the generated aliases take the format of `sql.database_name`. However, the alias name is completely customizable via a prefix parameter or a alias generation function (or both!).

### About this plugin
This plugin provides 3 seperate functions:

#### sqlclConnectHelper
<details>
This function is a wrapper around the SQLcl CLI program. SQLcl uses the same connection syntax as SQLPlus, which is not super friendly to scripting. So, the `sqlclConnectHelper` function provides a unix-style parameter driven command line experience and then calls SQLcl with the provided information converted to a format that SQLcl understands.

For instance, a SQLcl connection may look like this:
```shell
sql -L -noupdates my_user/my_password@my_database
```

However, with the `sqlclConnectHelper` function, instead the connection could be made in any of the following ways:
```shell
sqlclConnectHelper -Lzu my_user -p my_password -i my_database
sqlclConnectHelper -L -z -u my_user -p my_password -i my_database
sqlclConnectHelper -zLi my_database -u my_user -p my_password
```

Which allows information to be given in any order.

This wrapper script is used by the aliases generated by the `sqlclGenerateOIDAliases` and `sqlclGenerateTNSAliases` functions. This is necessary because the aliases are for known database connect identifiers, but the username is not specified until the user invokes the alias. Because this is backwards from the format expected by SQLcl (`user@database`), the helper script is used.

The wrapper script provides all the same functionality as the base SQLcl CLI program, though it uses all single letter options, so it is not an exact mapping. To see all the options for the `sqlclConnectHelper` function, simply run:
```shell
sqlclConnectHelper -h
```
</details>

#### sqlclGenerateOIDAliases
<details>
This function outputs aliases for database connections collected from a provided OID LDAP server along with an additional header about the parameters used to generate the aliases.

The function accepts various information about the OID LDAP server to query as well as optional parameters of the SQLcl binary to use, the name of a custom function that prints to standard output additional aliases based on each database, as well as the name of a custom function that prints to standard output the alias to use for a given database connection alias.

Given that some LDAP servers limit the number of entities returned by the anonymous user, this function does not attempt to query all the available information in a single query call. Instead, it will first query all of the contexts (how databases are organized in an OID LDAP server). Then, the function will query each context individually for all the databases in that context. The function does the database queries in the background so they all may be done in parallel in order to improve performance. However, depending on the number of contexts and databases, this function may still take a little bit of time to run. With approximately 1100 databases spread across 80 contexts, the function takes approximately 50 seconds to run.

Additionally, the generated aliases set the `LDAPCON` variable that SQLcl uses for LDAP lookups for the specific connection. This way, if you have multiple LDAP servers, you do not have to manually update the `LDAPCON` variable when trying to connect to a database in a different LDAP.
</details>

#### sqlclGenerateTNSAliases
<details>
This function outputs aliases for database connections collected from a provided TNS names file or cloud wallet along wtih an additional header about the parameters used to generate the aliases.

The function accepts either a tnsnames.ora file in the standard oracle location, a file path pointing to a TNS names file, or a file path pointing to a cloud wallet zip file. It also optionally accepts parameters for the SQLcl binary to use, the name of a custom function that prints to standard output additional aliases based on each database, as well as the name of a custom function that prints to standard output the alias to use for a given database connection alias.
</details>

## Requirements
- A ZSH or BASH shell
- SQLcl

## Installation

### Manual installation (ZSH)
```shell
git clone 'https://github.com/jasonlyle88/sqlcl-connection-alias-generators' "${XDG_CONFIG_HOME:-${HOME}}/sqlcl-connection-alias-generators"
echo 'source "${XDG_CONFIG_HOME:-${HOME}}/sqlcl-connection-alias-generators/sqlcl-connection-alias-generators.plugin.zsh"' >> "${HOME}/.zshrc"
source "${XDG_CONFIG_HOME:-${HOME}}/sqlcl-connection-alias-generators/sqlcl-connection-alias-generators.plugin.zsh"
```

### Manual installation (BASH)
```shell
git clone 'https://github.com/jasonlyle88/sqlcl-connection-alias-generators' "${XDG_CONFIG_HOME:-${HOME}}/sqlcl-connection-alias-generators"
echo 'source "${XDG_CONFIG_HOME:-${HOME}}/sqlcl-connection-alias-generators/sqlcl-connection-alias-generators.plugin.bash"' >> "${HOME}/.bashrc"
source "${XDG_CONFIG_HOME:-${HOME}}/sqlcl-connection-alias-generators/sqlcl-connection-alias-generators.plugin.bash"
```

### Installation with ZSH package managers

#### [Antidote](https://getantidote.github.io/)
Add `jasonlyle88/sqlcl-connection-alias-generators` to your plugins file (default is `~/.zsh_plugins.txt`)

#### [Oh-My-Zsh](https://ohmyz.sh/)
```shell
git clone 'https://github.com/jasonlyle88/sqlcl-connection-alias-generators' "${ZSH_CUSTOM:-${HOME}/.oh-my-zsh/custom}/plugins/sqlcl-connection-alias-generators"
omz plugin enable sqlcl-connection-alias-generators
```

#### Others
This should be compatible with other ZSH frameworks/package managers, but I have not tested them. If you have tested this plugin with another package manager, feel free to create a merge request and add the instructions here!

## Usage

### Additional alias generation functions
TODO

### Alias name formatting functions
TODO

### EVAL or SOURCE
Because the `sqlclGenerateOIDAliases` and `sqlclGenerateTNSAliases` functions output their information to standard output, the data must be captured and used. There are two general ways to do this:

- Immediately run the output information with the `eval` command
- Store the output information in a file and use the `source` command to load the contents of that file into your current session.

#### EVAL
Using `eval` will immediately evaluate all the generated aliases, but those aliases are not saved for future terminals to use. This means that your aliases are the most up to date since they were parsed directly and added to your session; however it also means that the `sqlclGenerateOIDAliases` or `sqlclGenerateTNSAliases` functions must be run every time you start a new terminal session since the aliases are not saved anywhere.

This can generically be accomplished by doing the following:
```shell
eval "$([GENERATION_FUNCTION_INVOCATION])"
```
Where `[GENERATION_FUNCTION_INVOCATION]` is an invocation of `sqlclGenerateOIDAliases` or `sqlclGenerateTNSAliases` with parameters appropriate for what you want to generate.

A specific example is:
```shell
eval "$(sqlclGenerateTNSAliases -T -p 'sql.tns.')"
```
Which will load aliases for a `tnsnames.ora` file in the standard location oracle expects with a prefix of `sql.tns.`.

#### SOURCE
Using `source` requires you first save the aliases in a file that can then be loaded into your terminal session over and over again without having to run the `sqlclGenerateOIDAliases` or `sqlclGenerateTNSAliases` functions again. This allows for faster loading of your aliases since they don't need to be generated, but it also means that your aliases could be out of date if it has been a while since you ran the generation functions.

This can generically be accomplished by doing the following:
```shell
[GENERATION_FUNCTION_INVOCATION] > ~/tnsnames_aliases.sh
source ~/tnsnames_aliases.sh
```

A specific example is:
```shell
sqlclGenerateTNSAliases -T -p 'sql.tns.' > ~/tnsnames_aliases.sh
source ~/tnsnames_aliases.sh
```

Then, whenever you start a new terminal, you just need to run:
```shell
source ~/tnsnames_aliases.sh
```
and all the generated aliases will be available to you again in your new terminal session.

### Automatically adding aliases to your terminal session
If you want your aliases to be available as soon as your terminal loads, you can add code to your `.bashrc`, `.bash_profile`, `.zshrc`, or any file you run when your shell starts. This will be specific to your machine and which file to use is outside the scope of this document. There are tons of resources avialable if your google it though!

Using the `eval` method in such a file will provide the most up to date aliases but may slow down your terminal starting up. If you create and `eval` with a call to `sqlclGenerateOIDAliases` that takes 30 seconds, then you are adding 30 seconds to your shell startup before you are able to use your terminal.

Using the `source` method, you only need to put the `source` command in your startup file. This will be very fast, but your aliases may be out of date if the database inormation has changed. To update the information, the generation functions will need to be run again (in our example, `sqlclGenerateTNSAliases -T -p 'sql.tns.' > ~/tnsnames_aliases.sh`).

### My approach
I personally use the source approach because my OID LDAP generation can take a while. In order to make updating the file containing the generated aliases easier, I create a function that generates the aliases for me. In order to accomplish this, I add the following to my `.zshrc` file:
```shell
export SQLCL_ALIAS_FILE="${HOME}/.config/sqlclAliases.sh"

function generateSqlclAliases() {
    sqlclGenerateTNSAliases -T > "${SQLCL_ALIAS_FILE}"

    sqlclGenerateTNSAliases -c "${TNS_ADMIN}/wallets/Wallet_db1.zip" -p 'sql.db1.' >> "${SQLCL_ALIAS_FILE}"

    sqlclGenerateTNSAliases -c "${TNS_ADMIN}/wallets/Wallet_db2.zip" -p 'sql.db2.' >> "${SQLCL_ALIAS_FILE}"

    sqlclGenerateOIDAliases -h "${WORK_DATABASE_LDAP_HOST}" -p 'sql.work.' >> "${SQLCL_ALIAS_FILE}"

    source "${SQLCL_ALIAS_FILE}"
}

if [[ -f "${SQLCL_ALIAS_FILE}" ]]; then
    source "${SQLCL_ALIAS_FILE}"
fi
```

This allows all my new terminal sessions to automatically have all my SQLcl aliases loaded from the last time they were generated. And any time I need to refresh the alias generation, I just run the `generateSqlclAliases` function.
